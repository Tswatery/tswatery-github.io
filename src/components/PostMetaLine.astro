---
interface Props {
  weather?: string;
  mood?: string;
  rating?: number;
  class?: string;
}

const { weather, mood, rating, class: className } = Astro.props as Props;

const emojiRegex = /[\u2600-\u27BF\u{1F300}-\u{1FAFF}]/u;
const weatherEmojiMap: Record<string, string> = {
  æ™´: 'â˜€ï¸',
  æ™´å¤©: 'â˜€ï¸',
  å¤šäº‘: 'â›…',
  é˜´: 'â˜ï¸',
  é˜´å¤©: 'â˜ï¸',
  é›¨: 'ğŸŒ§ï¸',
  ä¸‹é›¨: 'ğŸŒ§ï¸',
  é›·: 'â›ˆï¸',
  é›·é›¨: 'â›ˆï¸',
  é›ª: 'â„ï¸',
  ä¸‹é›ª: 'â„ï¸',
  é£: 'ğŸŒ¬ï¸',
  é›¾: 'ğŸŒ«ï¸',
  éœ¾: 'ğŸŒ',
};

const moodEmojiMap: Record<string, string> = {
  å¼€å¿ƒ: 'ğŸ˜Š',
  é«˜å…´: 'ğŸ˜Š',
  å¿«ä¹: 'ğŸ˜Š',
  èˆ’æœ: 'ğŸ˜Œ',
  æ”¾æ¾: 'ğŸ˜Œ',
  æœŸå¾…: 'ğŸ¤©',
  ä¸“æ³¨: 'ğŸ¯',
  è®¤çœŸ: 'ğŸ§',
  æ¿€åŠ¨: 'ğŸ¤—',
  å…´å¥‹: 'ğŸ¤©',
  ç´§å¼ : 'ğŸ˜°',
  ç„¦è™‘: 'ğŸ˜Ÿ',
  ç–²æƒ«: 'ğŸ˜´',
  ç”Ÿæ°”: 'ğŸ˜ ',
  éš¾è¿‡: 'ğŸ˜¢',
  ä½è½: 'ğŸ™',
  æ²®ä¸§: 'ğŸ˜',
};

function normalizeEmoji(value: string | undefined, replacements: Record<string, string>) {
  if (!value) return undefined;
  const trimmed = value.trim();
  if (!trimmed) return undefined;
  if (emojiRegex.test(trimmed)) return trimmed;
  for (const key in replacements) {
    if (trimmed.includes(key)) {
      return replacements[key];
    }
  }
  return trimmed;
}

const displayWeather = normalizeEmoji(weather, weatherEmojiMap);
const displayMood = normalizeEmoji(mood, moodEmojiMap);

const hasWeather = Boolean(displayWeather);
const hasMood = Boolean(displayMood);
const normalizedRating = typeof rating === 'number' ? Math.round(rating) : undefined;
const safeRating = typeof normalizedRating === 'number' && normalizedRating > 0
  ? Math.min(5, Math.max(1, normalizedRating))
  : undefined;
const hasRating = typeof safeRating === 'number';
const ratingLabels = ['', 'æå·®', 'æœ‰ç‚¹å·®', 'ä¸€èˆ¬', 'æœ‰ç‚¹å¥½', 'æå¥½'];
const stars = hasRating && safeRating ? Array.from({ length: safeRating }) : [];
const ratingLabel = hasRating && safeRating ? ratingLabels[safeRating] || 'ä¸€èˆ¬' : undefined;
const containerClasses = `flex flex-wrap items-center gap-2 text-sm text-muted ${className ?? ''}`;
---

{(hasWeather || hasMood || hasRating) && (
  <div class={containerClasses}>
    {hasWeather && (
      <div class="flex items-center gap-1">
        <span class="text-lg">{displayWeather}</span>
        <span>å¤©æ°”</span>
      </div>
    )}

    {hasWeather && (hasMood || hasRating) && (
      <span class="text-sm text-muted">â€¢</span>
    )}

    {hasMood && (
      <div class="flex items-center gap-1">
        <span class="text-lg">{displayMood}</span>
      </div>
    )}

    {hasMood && hasRating && (
      <span class="text-sm text-muted">â€¢</span>
    )}

    {hasRating && safeRating && (
      <div class="flex items-center gap-1">
        {stars.map(() => (
          <span class="text-yellow-500">â­</span>
        ))}
        {ratingLabel && (
          <span class="text-xs ml-1">
            ({ratingLabel})
          </span>
        )}
      </div>
    )}
  </div>
)}
