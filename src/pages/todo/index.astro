---
import Layout from '../../layouts/BaseLayout.astro';
import { promises as fs } from 'fs';
import path from 'path';

// è·å–åŸºç¡€è·¯å¾„
const basePath = Astro.config?.base || '/';

// TODO æ•°æ®æ–‡ä»¶è·¯å¾„
const todoFilePath = path.join(process.cwd(), 'src/content/todo/items.md');

let todoContent = '';
let todoItems = [];

try {
  // è¯»å– TODO æ–‡ä»¶
  if (await fs.stat(todoFilePath).catch(() => null)) {
    todoContent = await fs.readFile(todoFilePath, 'utf-8');

    // è§£æ TODO é¡¹ç›®ï¼ˆæ”¯æŒ - [ ] å’Œ - [x] æ ¼å¼ï¼‰
    const lines = todoContent.split('\n');
    let currentSection = '';
    let currentMonth = '';

    for (const line of lines) {
      // æ£€æµ‹æœˆä»½æ ‡é¢˜ (æ ¼å¼: ## 2025å¹´1æœˆ æˆ– ## 2025-01)
      const monthMatch = line.match(/^##\s*(\d{4})[å¹´-](\d{1,2})[æœˆ]?/);
      if (monthMatch) {
        currentMonth = `${monthMatch[1]}-${monthMatch[2].padStart(2, '0')}`;
        currentSection = line.replace(/^##\s*/, '');
        continue;
      }

      // æ£€æµ‹å…¶ä»–æ ‡é¢˜
      if (line.startsWith('#') && !line.startsWith('##')) {
        currentSection = line.replace(/^#+\s*/, '');
        currentMonth = '';
        continue;
      }

      // æ£€æµ‹ TODO é¡¹ç›®
      const todoMatch = line.match(/^-\s*\[([ x])\]\s*(.+)$/);
      if (todoMatch) {
        const [, checked, text] = todoMatch;
        todoItems.push({
          text,
          completed: checked === 'x',
          section: currentSection,
          month: currentMonth
        });
      }
    }
  }
} catch (error) {
  console.error('è¯»å– TODO æ–‡ä»¶å¤±è´¥:', error);
}

// ç»Ÿè®¡ä¿¡æ¯
const totalTasks = todoItems.length;
const completedTasks = todoItems.filter(item => item.completed).length;
const pendingTasks = totalTasks - completedTasks;
const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

// æŒ‰åˆ†ç»„ç»Ÿè®¡
const sections = todoItems.reduce((acc, item) => {
  const section = item.section || 'æœªåˆ†ç»„';
  if (!acc[section]) {
    acc[section] = {
      items: [],
      completed: 0,
      total: 0,
      month: item.month || ''
    };
  }
  acc[section].items.push(item);
  acc[section].total++;
  if (item.completed) acc[section].completed++;
  acc[section].month = item.month || '';
  return acc;
}, {});

// è·å–å½“å‰æœˆä»½
const now = new Date();
const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
const currentMonthName = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' });

// æŸ¥æ‰¾å½“å‰æœˆä»½çš„åˆ†ç»„
const currentMonthSection = Object.entries(sections).find(([_, data]) => data.month === currentMonthStr);

// ä¿®æ”¹å½“å‰æœˆä»½çš„æ ‡é¢˜ä¸º"æœ¬æœˆä»»åŠ¡æ¸…å•"
if (currentMonthSection) {
  const [sectionKey, sectionData] = currentMonthSection;
  delete sections[sectionKey];
  sections['æœ¬æœˆä»»åŠ¡æ¸…å•'] = sectionData;
}
---

<Layout
  title="TODO æ¸…å•"
  description="ä»»åŠ¡ç®¡ç†æ¸…å•"
>
  <article class="prose max-w-none">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-4">TODO æ¸…å•</h1>
      <div class="bg-code-bg rounded-lg p-4 inline-flex items-center gap-6">
        <div class="flex items-center gap-2">
          <span class="text-sm text-muted">æ€»ä»»åŠ¡:</span>
          <span class="font-semibold">{totalTasks}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-muted">å¾…å®Œæˆ:</span>
          <span class="font-semibold text-orange-600">{pendingTasks}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-muted">å·²å®Œæˆ:</span>
          <span class="font-semibold text-green-600">{completedTasks}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-muted">å®Œæˆç‡:</span>
          <span class="font-semibold">{completionRate}%</span>
        </div>
      </div>
    </header>

    {/* è¿›åº¦æ¡ */}
    {totalTasks > 0 && (
      <div class="mb-8">
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div
            class="bg-gradient-to-r from-blue-500 to-green-500 h-full rounded-full transition-all duration-500"
            style={`width: ${completionRate}%`}
          ></div>
        </div>
      </div>
    )}

    {/* æ— ä»»åŠ¡æç¤º */}
    {todoItems.length === 0 && (
      <div class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ“</div>
        <h2 class="text-xl font-semibold mb-2">è¿˜æ²¡æœ‰ä»»åŠ¡</h2>
        <p class="text-muted">
          è¯·åœ¨ <code class="bg-code-bg px-2 py-1 rounded text-sm">src/content/todo/items.md</code> æ–‡ä»¶ä¸­æ·»åŠ ä»»åŠ¡
        </p>
        <p class="text-sm text-muted mt-4">
          æ ¼å¼ç¤ºä¾‹ï¼š<br />
          <code class="bg-code-bg px-2 py-1 rounded text-xs">- [ ] å¾…å®Œæˆä»»åŠ¡</code><br />
          <code class="bg-code-bg px-2 py-1 rounded text-xs">- [x] å·²å®Œæˆä»»åŠ¡</code>
        </p>
      </div>
    )}

    {/* å½“å‰æœˆä»½å¿«é€Ÿå¯¼èˆª */}
    {currentMonthSection && (
      <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-blue-900">æœ¬æœˆä»»åŠ¡æ¸…å•</h3>
            <p class="text-blue-700">{currentMonthName}</p>
          </div>
          <a
            href={`#month-${currentMonthStr}`}
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            æŸ¥çœ‹è¯¦æƒ…
          </a>
        </div>
      </div>
    )}

    {/* ä»»åŠ¡åˆ—è¡¨ */}
    {Object.entries(sections).map(([sectionName, sectionData]) => (
      <section class="mb-8" id={sectionData.month ? `month-${sectionData.month}` : undefined}>
        <h2 class="text-2xl font-semibold mb-4 text-fg flex items-center gap-2">
          {sectionName}
          {sectionData.month && sectionData.month === currentMonthStr && sectionName !== 'æœ¬æœˆä»»åŠ¡æ¸…å•' && (
            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-sm rounded">æœ¬æœˆ</span>
          )}
          <span class="text-sm text-muted">
            ({sectionData.completed}/{sectionData.total})
          </span>
        </h2>
        <div class="space-y-3">
          {sectionData.items.map((item, index) => (
            <div
              class={`
                flex items-start gap-3 p-4 rounded-lg border transition-all duration-200
                ${item.completed
                  ? 'bg-green-50 border-green-200'
                  : 'bg-white border-border hover:shadow-md'
                }
              `}
            >
              <div class={`
                mt-0.5 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors
                ${item.completed
                  ? 'bg-green-500 border-green-500'
                  : 'border-gray-300 hover:border-primary'
                }
              `}>
                {item.completed && (
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                )}
              </div>
              <p class={`
                flex-1 text-fg
                ${item.completed ? 'line-through text-muted' : ''}
              `}>
                {item.text}
              </p>
            </div>
          ))}
        </div>
      </section>
    ))}

    {/* ä½¿ç”¨è¯´æ˜ */}
    <div class="mt-12 p-6 bg-code-bg rounded-lg">
      <h3 class="text-lg font-semibold mb-3">ä½¿ç”¨è¯´æ˜</h3>
      <ol class="list-decimal list-inside space-y-2 text-sm text-fg">
        <li>ç¼–è¾‘ <code class="bg-white px-2 py-1 rounded">src/content/todo/items.md</code> æ–‡ä»¶</li>
        <li>ä½¿ç”¨ Markdown æ ¼å¼æ·»åŠ ä»»åŠ¡ï¼š</li>
        <li class="ml-6">
          <code class="bg-white px-2 py-1 rounded">- [ ] ä»»åŠ¡åç§°</code> - æœªå®Œæˆä»»åŠ¡
        </li>
        <li class="ml-6">
          <code class="bg-white px-2 py-1 rounded">- [x] ä»»åŠ¡åç§°</code> - å·²å®Œæˆä»»åŠ¡
        </li>
        <li>å¯ä»¥ä½¿ç”¨æ ‡é¢˜ï¼ˆ##ï¼‰å¯¹ä»»åŠ¡è¿›è¡Œåˆ†ç»„</li>
        <li class="ml-6">
          <code class="bg-white px-2 py-1 rounded">## 2025å¹´1æœˆ</code> æˆ– <code class="bg-white px-2 py-1 rounded">## 2025-01</code> - æŒ‰æœˆä»½åˆ†ç»„
        </li>
        <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å½“å‰æœˆä»½å¹¶æä¾›å¿«é€Ÿå¯¼èˆª</li>
        <li>ä¿å­˜æ–‡ä»¶ååˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°</li>
      </ol>
    </div>
  </article>
</Layout>

<style>
  /* è‡ªå®šä¹‰æ ·å¼ */
  .prose h2 {
    border-bottom: 2px solid var(--border);
    padding-bottom: 0.5rem;
  }
</style>