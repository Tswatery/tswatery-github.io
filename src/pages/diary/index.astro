---
import Layout from '../../layouts/BaseLayout.astro';
import { promises as fs } from 'fs';
import path from 'path';

interface DiaryEntry {
  title: string;
  date: string;
  fileDate: string;
  mood: string;
  rating: number;
  weather: string;
  content: string;
  tags: string[];
  fileName: string;
  hasCustomDate: boolean;
}

const diaryDir = path.join(process.cwd(), 'src/content/diary');

// è¯»å–æ‰€æœ‰ Markdown æ–‡ä»¶
const entries: DiaryEntry[] = [];

try {
  const files = await fs.readdir(diaryDir);

  for (const file of files) {
    // æ”¯æŒæ‰€æœ‰ Markdown æ–‡ä»¶
    if (file.endsWith('.md') || file.endsWith('.markdown')) {
      const filePath = path.join(diaryDir, file);
      const content = await fs.readFile(filePath, 'utf-8');

      // é»˜è®¤å€¼
      let title = path.basename(file, path.extname(file));
      let customDate = '';
      let mood = 'ğŸ˜Š';
      let rating = 3;
      let weather = 'ğŸŒ¤ï¸';
      let tags: string[] = [];
      let markdownContent = content;
      let hasCustomDate = false;

      // æ£€æŸ¥æ˜¯å¦æœ‰ Front Matter
      if (content.startsWith('---')) {
        const endIndex = content.indexOf('---', 3);
        if (endIndex !== -1) {
          const frontMatter = content.slice(3, endIndex).trim();
          markdownContent = content.slice(endIndex + 3).trim();

          // è§£æ Front Matterï¼ˆå¯é€‰ï¼‰
          const titleMatch = frontMatter.match(/title:\s*(.+)/);
          if (titleMatch) title = titleMatch[1].trim().replace(/['"]/g, '');

          const dateMatch = frontMatter.match(/date:\s*(.+)/);
          if (dateMatch) {
            customDate = dateMatch[1].trim().replace(/['"]/g, '');
            hasCustomDate = true;
          }

          const moodMatch = frontMatter.match(/mood:\s*(.+)/);
          if (moodMatch) mood = moodMatch[1].trim();

          const ratingMatch = frontMatter.match(/rating:\s*(\d+)/);
          if (ratingMatch) rating = parseInt(ratingMatch[1]);

          const weatherMatch = frontMatter.match(/weather:\s*(.+)/);
          if (weatherMatch) weather = weatherMatch[1].trim();

          const tagsMatch = frontMatter.match(/tags:\s*\[([^\]]*)\]/);
          if (tagsMatch) {
            tags = tagsMatch[1]
              .split(',')
              .map(t => t.trim().replace(/['"]/g, ''))
              .filter(t => t);
          }
        }
      }

      // è·å–æ–‡ä»¶æ—¶é—´ï¼ˆä¼˜å…ˆä½¿ç”¨åˆ›å»ºæ—¶é—´ï¼‰
      const stats = await fs.stat(filePath);
      let displayDate: string;

      if (hasCustomDate && customDate) {
        // å¦‚æœæœ‰è‡ªå®šä¹‰æ—¥æœŸï¼Œç›´æ¥ä½¿ç”¨
        displayDate = customDate;
      } else {
        // ä½¿ç”¨æ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼ˆä¼˜å…ˆbirthtimeï¼Œå›é€€åˆ°ctimeï¼‰
        // æ³¨æ„ï¼šmtimeä¼šéšæ¯æ¬¡ä¿®æ”¹è€Œæ›´æ–°ï¼Œä¸èƒ½ä½¿ç”¨
        const originalDate = stats.birthtime || stats.ctime || stats.mtime;
        displayDate = new Intl.DateTimeFormat('zh-CN', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
        }).format(originalDate);
      }

      entries.push({
        title,
        date: displayDate,
        fileDate: displayDate,
        mood,
        rating,
        weather,
        content: markdownContent,
        tags,
        fileName: file,
        hasCustomDate,
      });
    }
  }
} catch (error) {
  console.error('è¯»å–å°è®°æ–‡ä»¶å¤±è´¥:', error);
}

// æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
const sortedEntries = entries.sort((a, b) =>
  new Date(a.fileDate).getTime() - new Date(b.fileDate).getTime()
).reverse();

// æŒ‰æ—¥æœŸåˆ†ç»„
const groupedEntries = sortedEntries.reduce((groups: Record<string, DiaryEntry[]>, entry) => {
  const dateOnly = entry.fileDate.split(' ')[0]; // æå–æ—¥æœŸéƒ¨åˆ†
  if (!groups[dateOnly]) {
    groups[dateOnly] = [];
  }
  groups[dateOnly].push(entry);
  return groups;
}, {});

const pageTitle = 'æ¯æ—¥å°è®°';
const pageDescription = 'è®°å½•ç”Ÿæ´»ä¸­çš„ç‚¹ç‚¹æ»´æ»´';
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="space-y-8">
    <header class="border-b pb-6">
      <h1 class="text-4xl font-bold mb-4">{pageTitle}</h1>
      <p class="text-muted">{pageDescription}</p>
    </header>

    <!-- æŒ‰æ—¥æœŸæ˜¾ç¤ºå°è®° -->
    {Object.entries(groupedEntries).map(([date, entries]) => (
      <section class="space-y-4">
        <h2 class="text-2xl font-semibold border-b pb-2">
          {date}
          <span class="text-sm text-muted ml-2">
            ({entries.length} æ¡å°è®°)
          </span>
        </h2>

        <div class="space-y-4">
          {entries.map((entry) => (
            <article class="bg-white border border-border rounded-lg p-6 hover:shadow-md transition-shadow">
              {/* å°è®°æ ‡é¢˜ */}
              <h3 class="text-xl font-semibold mb-3 text-fg">{entry.title}</h3>

              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center space-x-3 text-sm text-muted">
                  <div class="flex items-center space-x-1">
                    <span class="text-lg">{entry.weather}</span>
                    <span>å¤©æ°”</span>
                  </div>
                  <span>â€¢</span>
                  <div class="flex items-center space-x-1">
                    <span class="text-lg">{entry.mood}</span>
                  </div>
                  <span>â€¢</span>
                  <div class="flex items-center space-x-1">
                    {Array.from({ length: entry.rating }).map(() => (
                      <span class="text-yellow-500">â­</span>
                    ))}
                    <span class="text-xs ml-1">
                      ({entry.rating === 1 && 'æå·®'}
                      {entry.rating === 2 && 'æœ‰ç‚¹å·®'}
                      {entry.rating === 3 && 'ä¸€èˆ¬'}
                      {entry.rating === 4 && 'æœ‰ç‚¹å¥½'}
                      {entry.rating === 5 && 'æå¥½'})
                    </span>
                  </div>
                </div>
                <time class="text-sm text-muted">{entry.fileDate}</time>
              </div>

              <div class="text-fg mb-3 leading-relaxed">
                {entry.content.split('\n').map(line => line.trim() ? <p>{line}</p> : <br />)}
              </div>

              {entry.tags && entry.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {entry.tags.map((tag) => (
                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))}
        </div>
      </section>
    ))}

    {entries.length === 0 && (
      <div class="text-center py-12">
        <p class="text-muted text-lg">è¿˜æ²¡æœ‰å°è®°ï¼Œå»æ·»åŠ ç¬¬ä¸€æ¡å§ï¼</p>
      </div>
    )}
  </div>
</Layout>

<style>
  .capitalize {
    text-transform: capitalize;
  }
</style>
